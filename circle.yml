machine:
  node:
    version: 6
  environment:
    CF_API: https://api.fr.cloud.gov
    CF_USERNAME: fbi-crime-explorer_deployer
    CF_ORGANIZATION: fbi-crime-explorer
    CF_SPACE: prototype
    CF_APP: crime-data-explorer
    PORT: 6005

dependencies:
  cache_directories:
    - ./node_modules
  post:
    - wget https://saucelabs.com/downloads/sc-latest-linux.tar.gz
    - tar -xzf sc-latest-linux.tar.gz

test:
  override:
    - cd sc-*-linux && ./bin/sc --user $SAUCE_USERNAME --api-key $SAUCE_ACCESS_KEY -i $CIRCLE_BUILD_NUM:
        background: true
    - npm run lint
    - npm run test
    - npm run coverage
    - npm run build && npm start:
        background: true
    - npm run test:browser
  post:
    - killall --wait npm sc server.js

deployment:
  production:
    branch: master
    commands:
      - curl -v -L -o cf-cli_amd64.deb 'https://cli.run.pivotal.io/stable?release=debian64&source=github'
      - sudo dpkg -i cf-cli_amd64.deb
      - npm run build
      - cf install-plugin autopilot -f -r CF-Community
      - cf api $CF_API
      - cf auth $CF_USERNAME $CF_PASSWORD && cf target -o $CF_ORGANIZATION -s $CF_SPACE
      - cf zero-downtime-push $CF_APP -f manifest.yml -p .
